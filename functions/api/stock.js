function toHex(t){return[...new Uint8Array(t)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function sha256Hex(t){t=(new TextEncoder).encode(t);return toHex(await crypto.subtle.digest("SHA-256",t))}function intervalHoursForDuration(t){return!Number.isFinite(t)||t<=1?1:t<=7?3:t<=30?6:12}function mapToStock(t){return t<10?{status:"out_of_stock",qty:0}:t<25?{status:"low_stock",qty:1+t%5}:{status:"in_stock",qty:6+t%55}}async function onRequestGet({request:t,env:e}){try{var n=new URL(t.url).searchParams.get("product_id");if(!n)return new Response(JSON.stringify({error:"Missing product_id"}),{status:400,headers:{"content-type":"application/json"}});var r=e.SUPABASE_URL,a=e.SUPABASE_ANON_KEY,o=e.STOCK_SECRET;if(!r||!a||!o)return new Response(JSON.stringify({error:"Missing env vars. Need SUPABASE_URL, SUPABASE_ANON_KEY, STOCK_SECRET"}),{status:500,headers:{"content-type":"application/json"}});var s=r+"/rest/v1/product_variants?select=id,duration_days&product_id=eq."+encodeURIComponent(n)+"&order=duration_days.asc",i=await fetch(s,{headers:{apikey:a,Authorization:"Bearer "+a,Accept:"application/json"}});if(!i.ok)return new Response(JSON.stringify({error:"Failed to fetch variants",details:await i.text()}),{status:500,headers:{"content-type":"application/json"}});var u=await i.json(),c=Date.now(),d=[];for(const w of u){var p=null==w.duration_days?null:Number(w.duration_days),S=intervalHoursForDuration(p),_=60*S*60*1e3,y=Math.floor(c/_),l=await sha256Hex(`${o}:${w.id}:`+y),f=mapToStock(parseInt(l.slice(0,8),16)%100),h=(y+1)*_;d.push({id:String(w.id),duration_days:p,interval_hours:S,bucket:y,next_change_utc:new Date(h).toISOString(),...f})}return new Response(JSON.stringify({product_id:n,variants:d}),{headers:{"content-type":"application/json"}})}catch(t){return new Response(JSON.stringify({error:String(t)}),{status:500,headers:{"content-type":"application/json"}})}}export{onRequestGet};