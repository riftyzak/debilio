<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="/styles/tailwind.css">
</head>
<body style="background:#000;color:#fff;padding:24px;font-family:system-ui;">
  <h1 style="font-size:28px;font-weight:800;margin-bottom:14px;">dashboard</h1>

  <div id="authBox" style="max-width:520px;border:2px solid #333;border-radius:12px;padding:16px;background:rgba(20,20,20,.95);">
    <div style="margin-bottom:10px;color:#aaa;">Login or create account</div>
    <input id="username" placeholder="username" style="width:100%;margin:6px 0;padding:10px;border-radius:8px;border:2px solid #333;background:#000;color:#fff;">
    <input id="pass" type="password" placeholder="password" style="width:100%;margin:6px 0;padding:10px;border-radius:8px;border:2px solid #333;background:#000;color:#fff;">
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button id="login" style="padding:10px 14px;border:2px solid #333;border-radius:8px;background:#000;color:#fff;cursor:pointer;">Login</button>
      <button id="signup" style="padding:10px 14px;border:2px solid #333;border-radius:8px;background:#000;color:#fff;cursor:pointer;">Register</button>
    </div>
    <div id="authMsg" style="margin-top:10px;color:#aaa;white-space:pre-wrap;"></div>
  </div>

  <div id="dashBox" style="display:none;max-width:520px;margin-top:18px;border:2px solid #333;border-radius:12px;padding:16px;background:rgba(20,20,20,.95);">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
      <div>Signed in as <b id="me"></b></div>
      <button id="logout" style="padding:8px 12px;border:2px solid #333;border-radius:8px;background:#000;color:#fff;cursor:pointer;">Logout</button>
    </div>

    <hr style="border:0;border-top:1px solid #222;margin:14px 0;">

    <div style="margin-bottom:8px;color:#aaa;">Redeem a key</div>
    <input id="key" placeholder="xxxxx-xxxxx-..." style="width:100%;margin:6px 0;padding:10px;border-radius:8px;border:2px solid #333;background:#000;color:#fff;">
    <button id="redeem" style="margin-top:10px;padding:10px 14px;border:2px solid #333;border-radius:8px;background:#000;color:#fff;cursor:pointer;">Redeem</button>

    <div id="redeemMsg" style="margin-top:10px;color:#aaa;white-space:pre-wrap;"></div>
  </div>

  <script>
    const authBox = document.getElementById("authBox");
    const dashBox = document.getElementById("dashBox");
    const authMsg = document.getElementById("authMsg");
    const redeemMsg = document.getElementById("redeemMsg");

    function setAuthMsg(t){ authMsg.textContent = t || ""; }
    function setRedeemMsg(t){ redeemMsg.textContent = t || ""; }

    async function api(path, body) {
      const res = await fetch(path, {
        method: body ? "POST" : "GET",
        headers: body ? { "Content-Type": "application/json" } : undefined,
        body: body ? JSON.stringify(body) : undefined
      });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch { json = null; }
      return { ok: res.ok, json, text };
    }

    async function refresh() {
      const { ok, json } = await api("/api/auth/me");
      if (!ok || !json || !json.logged_in) {
        authBox.style.display = "block";
        dashBox.style.display = "none";
        return;
      }
      authBox.style.display = "none";
      dashBox.style.display = "block";
      document.getElementById("me").textContent = json.username || json.user_id;
    }

    document.getElementById("login").onclick = async () => {
      setAuthMsg("Logging in...");
      const username = document.getElementById("username").value.trim().toLowerCase();
      const password = document.getElementById("pass").value;
      const { ok, json, text } = await api("/api/auth/login", { username, password });
      setAuthMsg(ok ? "OK" : (json?.error || text));
      await refresh();
    };

    document.getElementById("signup").onclick = async () => {
      setAuthMsg("Creating account...");
      const username = document.getElementById("username").value.trim().toLowerCase();
      const password = document.getElementById("pass").value;
      const { ok, json, text } = await api("/api/auth/register", { username, password });
      setAuthMsg(ok ? "Registered. You can log in now." : (json?.error || text));
    };

    document.getElementById("logout").onclick = async () => {
      await api("/api/auth/logout", {});
      await refresh();
    };

    document.getElementById("redeem").onclick = async () => {
      setRedeemMsg("Redeeming...");
      const key = document.getElementById("key").value.trim();
      const { ok, json, text } = await api("/api/redeem", { key });
      setRedeemMsg(ok ? "Redeemed." : (json?.error || text));
    };

    refresh();
  </script>
</body>
</html>
