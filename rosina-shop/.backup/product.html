<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product ‚Ä¢ Rosina Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: 'Georama', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 90px 40px 20px;
      overflow-x: hidden;
      position: relative
    }

    /* match your "continuous" background approach */
    .background-text {
      position: fixed;
      top: 0;
      left: 0;
      width: 320%;
      height: 320%;
      font-size: 120px;
      font-weight: 700;
      color: rgba(255, 255, 255, .08);
      line-height: 1.1;
      letter-spacing: 8px;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
      animation: scroll-diagonal 50s linear infinite;
      font-family: 'Courier New', monospace
    }

    .background-text div {
      white-space: nowrap
    }

    .background-text div:nth-child(even) {
      padding-left: 150px
    }

    @keyframes scroll-diagonal {
      0% {
        transform: translate3d(0, 0, 0)
      }

      100% {
        transform: translate3d(-33.333%, -33.333%, 0)
      }
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 0 auto
    }

    .topbar {
      margin-bottom: 24px
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all .3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      z-index: 1100;
    }

    .back-button:hover {
      border-color: #4a90e2;
      transform: translateX(-5px)
    }

    .cart-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .cart-modal.show {
      display: flex;
    }

    .checkout-link {
      display: block;
      margin-top: 14px;
      text-align: center;
      padding: 12px 14px;
      border-radius: 10px;
      background: #111;
      color: #fff;
      text-decoration: none;
      font-weight: 700;
    }

    .checkout-link:hover {
      opacity: .92;
    }


    .cart-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all .3s ease;
      z-index: 1100;
    }

    .cart-button:hover {
      border-color: #4a90e2
    }

    .card {
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      border-radius: 16px;
      overflow: hidden
    }

    .card:hover {
      border-color: #4a90e2
    }

    .hero {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 0
    }

    @media (max-width:900px) {
      .hero {
        grid-template-columns: 1fr
      }
    }

    .img {
      background: #111;
      min-height: 360px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden
    }

    .img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .fallback {
      font-size: 72px;
      color: #333
    }

    .content {
      padding: 28px
    }

    .name {
      font-size: 34px;
      font-weight: 700;
      margin-bottom: 10px
    }

    .desc {
      color: #888;
      line-height: 1.7;
      margin-bottom: 18px;
      white-space: pre-wrap
    }

    .price {
      font-size: 30px;
      font-weight: 700;
      color: #4a90e2;
      margin-bottom: 18px
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .btn {
      flex: 1;
      min-width: 200px;
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      border: none;
      color: #fff;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all .3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 144, 226, .4)
    }

    .muted {
      margin-top: 16px;
      color: #888;
      font-size: 12px;
      line-height: 1.5
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: min(520px, 92vw)
    }

    .toast.show {
      display: block
    }

    .toast.success {
      border-color: #4a90e2
    }

    .toast.error {
      border-color: #dc3545
    }

    /* minimal cart styles (inline matches shop) */
    .qty {
      width: 70px;
      background: rgba(0, 0, 0, .5);
      border: 2px solid #333;
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      font-family: 'Georama', sans-serif
    }

    .remove-item {
      background: #dc3545;
      border: none;
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px
    }
  </style>
</head>

<body>
  <div class="background-text" id="bgText"></div>

  <div class="container">
    <div class="topbar">
      <a href="/rosina-shop/" class="back-button"><i class="fas fa-arrow-left"></i> Back to shop</a>
      <button class="cart-button" onclick="toggleCart()"><i class="fas fa-shopping-cart"></i> Cart <span id="cartCount"
          style="background:#4a90e2;color:#fff;border-radius:50%;padding:2px 8px;font-size:12px;margin-left:8px;">0</span></button>
    </div>

    <div class="card" id="productCard" style="display:none;"></div>

    <div class="card" id="notFound" style="padding:28px;display:none;">
      <div style="font-size:24px;font-weight:700;color:#4a90e2;margin-bottom:10px;">Product not found</div>
      <div style="color:#888;">Go back to the shop and pick a product.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Cart modal -->
  <div class="cart-modal" id="cartModal"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:1000;align-items:center;justify-content:center;">
    <div class="cart-content"
      style="background:rgba(20,20,20,.98);border:2px solid #4a90e2;border-radius:12px;padding:40px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
      <div class="cart-header"
        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
        <h2 class="cart-title" style="font-size:28px;font-weight:700;color:#4a90e2;">Your Cart</h2>
        <button class="close-cart" onclick="toggleCart()"
          style="background:none;border:none;color:#888;font-size:28px;cursor:pointer;">√ó</button>
      </div>

      <div id="cartItems"></div>

      <div class="promo-section" style="margin-top:30px;padding-top:20px;border-top:1px solid #333;">
        <div class="promo-input" style="display:flex;gap:10px;margin-bottom:15px;">
          <input type="text" id="promoCode" placeholder="Enter promo code"
            style="flex:1;background:rgba(0,0,0,.5);border:2px solid #333;color:#fff;padding:10px 15px;border-radius:6px;font-family:'Georama',sans-serif;font-size:14px;" />
          <button class="apply-promo" id="promoBtn" onclick="applyOrRemovePromo()"
            style="background:#4a90e2;border:none;color:#fff;padding:10px 20px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:700;">Apply</button>
        </div>
        <div class="promo-message" id="promoMessage"
          style="font-size:13px;margin-top:10px;padding:8px;border-radius:4px;display:none;"></div>
      </div>

      <div class="cart-total" id="cartTotal" style="margin-top:30px;padding-top:20px;border-top:2px solid #333;"></div>
      <a href="../checkout.html" class="checkout-link">Go to Checkout</a>
    </div>
  </div>

  <script>
    // =========================
    // Background
    // =========================
    const bgText = document.getElementById('bgText');
    const text = 'I LOVE RADEK NEVARIL ';
    let bgHtml = '';
    for (let i = 0; i < 100; i++) {
      let lineText = '';
      for (let j = 0; j < 10; j++) lineText += text;
      bgHtml += `<div>${lineText}</div>`;
    }
    bgText.innerHTML = bgHtml;

    // =========================
    // Supabase (REST) config
    // =========================
    const SUPABASE_URL = "https://euqvwswzbowbxweufaet.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Cbc3Z1lopGZdttsDkZO28w_C24B4hMT";

    function supaHeaders() {
      return {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Accept": "application/json"
      };
    }

    function getSlugFromPath() {
      // /rosina-shop/product/<slug>
      const m = window.location.pathname.match(/\/rosina-shop\/product\/([^/?#]+)/);
      if (m && m[1]) return decodeURIComponent(m[1]);

      // fallback: ?slug=
      const sp = new URLSearchParams(window.location.search);
      return sp.get("slug");
    }

    async function fetchProductBySlug(slug) {
      const url =
        `${SUPABASE_URL}/rest/v1/products` +
        `?select=id,title,slug,price_eur,description,image_url,is_active` +
        `&slug=eq.${encodeURIComponent(slug)}` +
        `&is_active=eq.true` +
        `&limit=1`;

      const res = await fetch(url, { headers: supaHeaders() });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      if (!data || !data[0]) return null;
      return { ...data[0], price_eur: Number(data[0].price_eur) };
    }


    // =========================
    // Product rendering
    // =========================
    function moneyEUR(v) { return `‚Ç¨${Number(v).toFixed(2)}`; }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderProduct(p) {
      document.title = `${p.title} ‚Ä¢ Rosina Shop`;

      const card = document.getElementById('productCard');
      card.style.display = 'block';

      card.innerHTML = `
      <div class="hero">
        <div class="img">
          ${p.image_url
          ? `<img src="${p.image_url}" alt="${escapeHtml(p.title)}" loading="lazy" />`
          : `<div class="fallback">üõçÔ∏è</div>`}
        </div>
        <div class="content">
          <div class="name">${escapeHtml(p.title)}</div>
          <div class="desc">${escapeHtml(p.description || "")}</div>
          <div class="price">${moneyEUR(p.price_eur)}</div>
          <div class="actions">
            <button class="btn" onclick="addToCart('${String(p.id)}')"><i class="fas fa-cart-plus"></i> Add to cart</button>
            <button class="btn" onclick="buyNow('${String(p.id)}')"><i class="fas fa-bolt"></i> Buy now</button>
          </div>
          <div class="muted">Payments can be connected later (Coinbase Commerce, etc.).</div>
        </div>
      </div>
    `;
    }

    let currentProduct = null;

    // =========================
    // Init
    // =========================
    (async () => {

      const slug = getSlugFromPath();
      if (!slug) {
        document.getElementById('notFound').style.display = 'block';
        return;
      }

      try {
        currentProduct = await fetchProductBySlug(slug);
      } catch (e) {
        console.error("Supabase fetch error:", e);
        currentProduct = null;
      }

      if (!currentProduct) {
        document.getElementById('notFound').style.display = 'block';
        return;
      }

      renderProduct(currentProduct);
    })();
  </script>
  <script src="../cart.js"></script>
</body>

</html>