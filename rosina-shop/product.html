<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product ‚Ä¢ Rosina Shop</title>
  <link href="https://fonts.googleapis.com/css2?family=Georama:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/styles/tailwind.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box
    }

    body {
      font-family: 'Georama', sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      padding: 40px 20px;
      overflow-x: hidden;
      position: relative
    }

    html,
    body {
      overflow: auto;
      scrollbar-width: none;
      
      -ms-overflow-style: none;
      
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    
    .background-text {
      position: fixed;
      top: 0;
      left: 0;
      width: 320%;
      height: 320%;
      font-size: 120px;
      font-weight: 700;
      color: rgba(255, 255, 255, .08);
      line-height: 1.1;
      letter-spacing: 8px;
      overflow: hidden;
      z-index: 0;
      pointer-events: none;
      animation: scroll-diagonal 50s linear infinite;
      font-family: 'Courier New', monospace
    }

    .background-text div {
      white-space: nowrap
    }

    .background-text div:nth-child(even) {
      padding-left: 150px
    }

    @keyframes scroll-diagonal {
      0% {
        transform: translate3d(0, 0, 0);
      }

      100% {
        transform: translate3d(-33.333%, -33.333%, 0);
      }
    }

    @keyframes gradient-shift {

      0%,
      100% {
        background-position: 0% center;
      }

      50% {
        background-position: 100% center;
      }
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1000px;
      margin: 0 auto
    }

    .topbar {
      margin-bottom: 24px
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all .3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      z-index: 1100;
    }

    .back-button:hover {
      border-color: #4a90e2;
      transform: translateX(-5px)
    }

    .cart-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .8);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .cart-modal.show {
      display: flex;
    }

    .checkout-link {
      display: block;
      margin-top: 14px;
      text-align: center;
      padding: 12px 14px;
      border-radius: 10px;
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      color: #fff;
      text-decoration: none;
      font-weight: 700;
      transition: all .3s ease;
    }

    .checkout-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 144, 226, .4);
    }


    .cart-button {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all .3s ease;
      z-index: 100;
    }

    .cart-button:hover {
      border-color: #4a90e2
    }

    .card {
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      border-radius: 16px;
      overflow: hidden
    }

    .card:hover {
      border-color: #4a90e2
    }

    .hero {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 0
    }

    @media (max-width:900px) {
      .hero {
        grid-template-columns: 1fr
      }
    }

    .img {
      background: #111;
      min-height: 360px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden
    }

    .img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block
    }

    .fallback {
      font-size: 72px;
      color: #333
    }

    .content {
      padding: 28px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .name {
      font-size: 34px;
      font-weight: 700;
      margin-bottom: 10px
    }

    .desc {
      color: #888;
      line-height: 1.7;
      margin-bottom: 18px;
      white-space: pre-wrap
    }

    .price {
      font-size: 30px;
      font-weight: 700;
      color: #4a90e2;
      margin-top: 16px;
      margin-bottom: 18px
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: auto;
    }

    .price-actions {
      margin-top: auto;
      display: flex;
      flex-direction: column;
    }

    .btn {
      flex: 1;
      min-width: 200px;
      background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
      border: none;
      color: #fff;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all .3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(74, 144, 226, .4)
    }

    .muted {
      margin-top: 16px;
      color: #888;
      font-size: 12px;
      line-height: 1.5
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(20, 20, 20, .95);
      border: 2px solid #333;
      color: #fff;
      padding: 12px 16px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: min(520px, 92vw)
    }

    .toast.show {
      display: block
    }

    .toast.success {
      border-color: #4a90e2
    }

    .toast.error {
      border-color: #dc3545
    }

    
    .qty {
      width: 70px;
      background: rgba(0, 0, 0, .5);
      border: 2px solid #333;
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      font-family: 'Georama', sans-serif
    }

    .remove-item {
      background: #dc3545;
      border: none;
      color: #fff;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px
    }


    @media (max-width: 480px) {
      body {
        padding: 80px 14px 20px !important;
      }

      .background-text {
        font-size: 72px !important;
        letter-spacing: 5px !important;
      }

      .back-button {
        padding: 10px 16px !important;
        font-size: 13px !important;
      }

      .cart-button {
        padding: 10px 16px !important;
        font-size: 14px !important;
      }
    }


    .header {
      text-align: center;
      margin-top: 40px;
      margin-bottom: 40px;
    }

    .title {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #fff, #4a90e2, #357abd, #fff);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradient-shift 3s ease infinite;
    }

    

    
    .duration-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }

    .duration-card {
      width: 100%;
      text-align: left;
      background: rgba(0, 0, 0, .35);
      border: 2px solid #333;
      color: #fff;
      padding: 14px 16px;
      border-radius: 14px;
      cursor: pointer;
      transition: all .2s ease;
      font-family: inherit;

      
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 14px;
      align-items: center;
    }

    .duration-card:hover {
      border-color: #4a90e2;
    }

    .duration-card.is-selected {
      border-color: #4a90e2;
      background: rgba(74, 144, 226, .12);
      box-shadow: 0 0 0 2px rgba(74, 144, 226, .22);
    }

    .duration-card:focus-visible {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, .35);
    }

    
    .duration-card.is-disabled,
    .duration-card:disabled {
      opacity: .55;
      cursor: not-allowed;
      border-color: #2b2b2b;
      background: rgba(0, 0, 0, .28);
    }

    .duration-card.is-disabled:hover,
    .duration-card:disabled:hover {
      border-color: #2b2b2b;
    }

    .duration-card__left {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .variant-title {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .variant-stock {
      font-size: 12px;
      line-height: 1.2;
    }

    .stock--in {
      color: #2ecc71;
    }

    
    .stock--low {
      color: #f39c12;
    }

    
    .stock--out {
      color: #e74c3c;
    }

    

    .variant-price {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
    }

    

    
    .actions.actions--row {
      flex-wrap: nowrap;
    }

    .actions.actions--row .btn {
      min-width: 0;
    }
  </style>
</head>

<body>
  <div class="background-text" id="bgText"></div>

  <div class="container">
    <div class="topbar">
      <a href="/rosina-shop/" class="back-button"><i class="fas fa-arrow-left"></i> Back to shop</a>
      <button class="cart-button" onclick="toggleCart()"><i class="fas fa-shopping-cart"></i> Cart <span id="cartCount"
          style="background:#4a90e2;color:#fff;border-radius:50%;padding:2px 8px;font-size:12px;margin-left:8px;">0</span></button>
    </div>

    <div class="header">
      <div class="title">Rosina Shop</div>
      <p style="color:#888;">Retired Pistolnik Store</p>
    </div>

    <div class="card" id="productCard" style="display:none;"></div>

    <div class="card" id="notFound" style="padding:28px;display:none;">
      <div style="font-size:24px;font-weight:700;color:#4a90e2;margin-bottom:10px;">Product not found</div>
      <div style="color:#888;">Go back to the shop and pick a product.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  
  <div class="cart-modal" id="cartModal"
    style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:1000;align-items:center;justify-content:center;">
    <div class="cart-content"
      style="background:rgba(20,20,20,.98);border:2px solid #4a90e2;border-radius:12px;padding:40px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
      <div class="cart-header"
        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;">
        <h2 class="cart-title" style="font-size:28px;font-weight:700;color:#4a90e2;">Your Cart</h2>
        <button class="close-cart" onclick="toggleCart()" aria-label="Close cart"
          style="background:none;border:none;color:#888;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;">
          <i class="fas fa-times" style="font-size:22px;" aria-hidden="true"></i>
        </button>
      </div>

      <div id="cartItems"></div>
      <div class="cart-total" id="cartTotal" style="margin-top:30px;padding-top:20px;border-top:2px solid #333;"></div>
      <a href="../checkout.html" class="checkout-link">Go to Checkout</a>
    </div>
  </div>

  <script>



    const bgText = document.getElementById('bgText');
    const text = 'I LOVE RADEK NEVARIL ';
    let bgHtml = '';
    for (let i = 0; i < 100; i++) {
      let lineText = '';
      for (let j = 0; j < 10; j++) lineText += text;
      bgHtml += `<div>${lineText}</div>`;
    }
    bgText.innerHTML = bgHtml;



    const SUPABASE_URL = "https://euqvwswzbowbxweufaet.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_Cbc3Z1lopGZdttsDkZO28w_C24B4hMT";

    function supaHeaders() {
      return {
        "apikey": SUPABASE_ANON_KEY,
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "Accept": "application/json"
      };
    }

    function getSlugFromPath() {

      const m = window.location.pathname.match(/\/rosina-shop\/product\/([^/?#]+)/);
      if (m && m[1]) return decodeURIComponent(m[1]);

      const sp = new URLSearchParams(window.location.search);
      return sp.get("slug");
    }

    async function fetchProductBySlug(slug) {
      const base = `${SUPABASE_URL}/rest/v1/products`;
      const selects = [
        "id,title,slug,price_eur,description,image_url,is_active,duration_days",
        "id,title,slug,price_eur,description,image_url,is_active"
      ];

      let data = null;
      for (const select of selects) {
        const url =
          `${base}` +
          `?select=${select}` +
          `&slug=eq.${encodeURIComponent(slug)}` +
          `&is_active=eq.true` +
          `&limit=1`;

        const res = await fetch(url, { headers: supaHeaders() });
        if (!res.ok) {
          if (res.status === 400 && select !== selects[selects.length - 1]) {
            continue;
          }
          throw new Error(await res.text());
        }
        data = await res.json();
        break;
      }

      if (!data || !data[0]) return null;
      return { ...data[0], price_eur: Number(data[0].price_eur) };
    }

    async function fetchVariantsByProductId(productId) {
      const base = `${SUPABASE_URL}/rest/v1/product_variants`;
      const selects = [
        "id,product_id,duration_days,price_eur"
      ];

      for (const select of selects) {
        const url =
          `${base}` +
          `?select=${select}` +
          `&product_id=eq.${encodeURIComponent(productId)}` +
          `&order=duration_days.asc`;

        const res = await fetch(url, { headers: supaHeaders() });
        if (!res.ok) {
          if (res.status === 400 && select !== selects[selects.length - 1]) {
            continue;
          }
          return [];
        }
        const data = await res.json();
        return (data || []).map((variant) => ({
          ...variant,
          price_eur: Number(variant.price_eur),
          duration_days:
            variant.duration_days !== null && variant.duration_days !== undefined
              ? Number(variant.duration_days)
              : null,
          auto_deliver: Boolean(variant.auto_deliver),
          delivery_text: variant.delivery_text || ""
        }));
      }

      return [];
    }
    async function fetchVariantStock(productId) {
      const res = await fetch(`/api/stock?product_id=${encodeURIComponent(productId)}`);
      if (!res.ok) return [];
      const data = await res.json();
      return data?.variants || [];
    }



    function moneyEUR(v) { return `‚Ç¨${Number(v).toFixed(2)}`; }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    let currentVariants = [];
    let selectedVariantId = null;

    function renderProduct(p) {
      document.title = `${p.title} ‚Ä¢ Rosina Shop`;

      const card = document.getElementById('productCard');
      card.style.display = 'block';

      const hasVariants = Array.isArray(currentVariants) && currentVariants.length > 0;

      function isVariantDisabled(variant) {
        const qtyRaw =
          variant.stock_qty ?? variant.stock ?? variant.quantity ?? variant.inventory_qty ?? variant.qty ?? null;
        const qty = (qtyRaw === null || qtyRaw === undefined || qtyRaw === "") ? null : Number(qtyRaw);

        const explicitOut =
          variant.is_in_stock === false ||
          variant.out_of_stock === true ||
          variant.purchase_disabled === true ||
          variant.disabled === true ||
          variant.is_active === false;

        const isOut = explicitOut || (Number.isFinite(qty) && qty <= 0);
        return isOut;
      }

      const defaultVariant = hasVariants
        ? (currentVariants.find(v => !isVariantDisabled(v)) || currentVariants[0])
        : null;

      selectedVariantId = (defaultVariant && !isVariantDisabled(defaultVariant)) ? String(defaultVariant.id) : null;

      card.innerHTML = `
      <div class="hero">
        <div class="img">
          ${p.image_url
          ? `<img src="${p.image_url}" alt="${escapeHtml(p.title)}" loading="lazy" />`
          : `<div class="fallback">üõçÔ∏è</div>`}
        </div>
        <div class="content">
          <div class="name">${escapeHtml(p.title)}</div>
          <div class="desc">${escapeHtml(p.description || "")}</div>
          ${hasVariants ? `
          <div style="margin-top:10px;">
            <label id="durationPickerLabel" style="display:block;color:#888;font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Choose duration</label>
            <div id="durationPicker" class="duration-grid" role="radiogroup" aria-labelledby="durationPickerLabel">
              ${currentVariants.map((variant) => {
            const id = String(variant.id);

            const daysNum = (variant.duration_days ?? null);
            const daySuffix = Number(daysNum) === 1 ? "" : "s";
            const derivedTitle = daysNum !== null ? `${daysNum} Day${daySuffix}` : "Duration";
            const title = (variant.title || variant.name || variant.label || "").trim() || derivedTitle;

            const qtyRaw =
              variant.stock_qty ?? variant.stock ?? variant.quantity ?? variant.inventory_qty ?? variant.qty ?? null;
            const qty = (qtyRaw === null || qtyRaw === undefined || qtyRaw === "") ? null : Number(qtyRaw);

            const explicitOut =
              variant.is_in_stock === false ||
              variant.out_of_stock === true ||
              variant.purchase_disabled === true ||
              variant.disabled === true ||
              variant.is_active === false;

            const isOut = explicitOut || (Number.isFinite(qty) && qty <= 0);
            const isLow = !isOut && Number.isFinite(qty) && qty > 0 && qty <= 3;

            const stockText = isOut ? "Out of stock" : (isLow ? "Low stock" : "In stock");
            const stockClass = isOut ? "stock--out" : (isLow ? "stock--low" : "stock--in");

            const isDisabled = isOut;
            const isSelected = !isDisabled && id === selectedVariantId;

            return `
                  <button
                    type="button"
                    class="duration-card${isSelected ? " is-selected" : ""}${isDisabled ? " is-disabled" : ""}"
                    data-variant-id="${escapeHtml(id)}"
                    ${isDisabled ? `disabled aria-disabled="true"` : ``}
                    role="radio"
                    aria-checked="${isSelected ? "true" : "false"}"
                    tabindex="${isSelected ? "0" : "-1"}">
                    <span class="duration-card__left">
                      <span class="variant-title">${escapeHtml(title)}</span>
                      <span class="variant-stock ${stockClass}">${stockText}</span>
                    </span>
                    <span class="variant-price">${moneyEUR(variant.price_eur)}</span>
                  </button>
                `;
          }).join("")}
            </div>
          </div>
          ` : ``}

          <div class="price-actions">
            <div class="price" id="priceLabel">${moneyEUR(hasVariants ? defaultVariant?.price_eur : p.price_eur)}</div>

            <div class="actions actions--row">
              <button class="btn" id="addToCartBtn"><i class="fas fa-cart-plus"></i> Add to cart</button>
              <button class="btn" id="buyNowBtn"><i class="fas fa-bolt"></i> Buy now</button>
            </div>
          </div>

        </div>
      </div>
    `;

      const priceLabel = document.getElementById("priceLabel");
      const durationPicker = document.getElementById("durationPicker");

      function syncVariantUI() {
        if (!durationPicker) return;

        const buttons = Array.from(durationPicker.querySelectorAll("button[data-variant-id]"));
        buttons.forEach((btn) => {
          const isDisabled = btn.disabled || btn.getAttribute("aria-disabled") === "true";
          const isSelected = !isDisabled && String(btn.dataset.variantId) === String(selectedVariantId);

          btn.setAttribute("aria-checked", isSelected ? "true" : "false");
          btn.classList.toggle("is-selected", isSelected);
          btn.tabIndex = isSelected ? 0 : -1;
        });

        if (!buttons.some(b => b.tabIndex === 0)) {
          const firstEnabled = buttons.find(b => !b.disabled && b.getAttribute("aria-disabled") !== "true");
          if (firstEnabled) firstEnabled.tabIndex = 0;
        }
      }



      function selectVariantById(variantId) {
        const variant = currentVariants.find((v) => String(v.id) === String(variantId));
        if (!variant || isVariantDisabled(variant)) return; // ignore disabled/out-of-stock

        selectedVariantId = String(variant.id);

        if (priceLabel) priceLabel.textContent = moneyEUR(variant.price_eur);

        syncVariantUI();
      }

      if (durationPicker) {
        durationPicker.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-variant-id]");
          if (!btn) return;
          if (btn.disabled || btn.getAttribute("aria-disabled") === "true") return; // ignore disabled
          selectVariantById(btn.dataset.variantId);
        });

        durationPicker.addEventListener("keydown", (e) => {
          const keys = ["ArrowDown", "ArrowUp", "ArrowRight", "ArrowLeft", "Home", "End", " ", "Enter"];
          if (!keys.includes(e.key)) return;

          const buttons = Array.from(durationPicker.querySelectorAll("button[data-variant-id]"))
            .filter(b => !b.disabled && b.getAttribute("aria-disabled") !== "true");

          if (!buttons.length) return;

          const current = document.activeElement?.closest?.("button[data-variant-id]");
          const currentIndex = Math.max(0, buttons.indexOf(current));

          let nextIndex = currentIndex;

          if (e.key === "Home") nextIndex = 0;
          if (e.key === "End") nextIndex = buttons.length - 1;
          if (e.key === "ArrowDown" || e.key === "ArrowRight") nextIndex = (currentIndex + 1) % buttons.length;
          if (e.key === "ArrowUp" || e.key === "ArrowLeft") nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;

          if (e.key === " " || e.key === "Enter") {
            e.preventDefault();
            if (current && !current.disabled) selectVariantById(current.dataset.variantId);
            return;
          }

          e.preventDefault();
          buttons[nextIndex].focus();
          selectVariantById(buttons[nextIndex].dataset.variantId);
        });
      }

      syncVariantUI();

      const addBtn = document.getElementById("addToCartBtn");
      const buyBtn = document.getElementById("buyNowBtn");
      if (addBtn) addBtn.addEventListener("click", () => addToCart(String(p.id), 1, selectedVariantId));
      if (buyBtn) buyBtn.addEventListener("click", () => buyNow(String(p.id), selectedVariantId));
    }

    let currentProduct = null;



    (async () => {

      const slug = getSlugFromPath();
      if (!slug) {
        document.getElementById('notFound').style.display = 'block';
        return;
      }

      try {
        currentProduct = await fetchProductBySlug(slug);
      } catch (e) {
        console.error("Supabase fetch error:", e);
        currentProduct = null;
      }

      if (!currentProduct) {
        document.getElementById('notFound').style.display = 'block';
        return;
      }

      if (currentProduct) {
        currentVariants = await fetchVariantsByProductId(currentProduct.id);

        const stockList = await fetchVariantStock(currentProduct.id);
        const stockById = new Map(stockList.map(s => [String(s.id), s]));

        currentVariants = currentVariants.map(v => {
          const s = stockById.get(String(v.id));
          if (!s) return v;
          return {
            ...v,
            stock_qty: s.qty,                 // <-- your UI already reads this
            is_in_stock: s.status !== "out_of_stock",
            out_of_stock: s.status === "out_of_stock",
          };
        });
      }


      renderProduct(currentProduct);
    })();
  </script>
  <script src="../cart.js"></script>
</body>

</html>
